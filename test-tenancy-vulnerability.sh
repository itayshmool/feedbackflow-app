#!/bin/bash
# Quick start script for testing tenancy vulnerability
# This is a helper script to make it easier to run the test

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     TENANCY VALIDATION VULNERABILITY TEST - QUICK START           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "âŒ Error: Node.js is not installed"
    echo "Please install Node.js 18+ to run this test"
    exit 1
fi

# Check Node.js version
NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
    echo "âš ï¸  Warning: Node.js version is $NODE_VERSION, but 18+ is recommended"
    echo "Installing node-fetch for compatibility..."
    npm install node-fetch 2>/dev/null || echo "Note: node-fetch install failed, continuing anyway"
fi

echo "ğŸ“‹ This test requires the following information:"
echo ""
echo "1. Admin A Token - JWT token from staging login"
echo "   How to get:"
echo "   - Login to https://feedbackflow-frontend-staging.onrender.com"
echo "   - Open DevTools (F12) > Application > Cookies"
echo "   - Copy the 'token' cookie value"
echo ""
echo "2. Organization B Details - A DIFFERENT organization that Admin A should NOT access"
echo "   How to get:"
echo "   - Login to staging as Admin A"
echo "   - Go to Administration > Organizations"
echo "   - Find another organization (not your own)"
echo "   - Note: Organization ID (UUID), Name, and Slug"
echo ""

# Check if parameters are already set as environment variables
if [ -z "$ADMIN_A_TOKEN" ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Enter Admin A Token (JWT from staging cookies):"
    read -r ADMIN_A_TOKEN
    export ADMIN_A_TOKEN
fi

if [ -z "$ADMIN_B_ORG_ID" ]; then
    echo ""
    echo "Enter Organization B ID (UUID):"
    read -r ADMIN_B_ORG_ID
    export ADMIN_B_ORG_ID
fi

if [ -z "$ADMIN_B_ORG_NAME" ]; then
    echo ""
    echo "Enter Organization B Name (e.g., 'Acme Corp'):"
    read -r ADMIN_B_ORG_NAME
    export ADMIN_B_ORG_NAME
fi

if [ -z "$ADMIN_B_ORG_SLUG" ]; then
    echo ""
    echo "Enter Organization B Slug (e.g., 'acme-corp'):"
    read -r ADMIN_B_ORG_SLUG
    export ADMIN_B_ORG_SLUG
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Starting vulnerability test..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run the test
node test-tenancy-vulnerability.js \
    --admin-a-token "$ADMIN_A_TOKEN" \
    --admin-b-org-id "$ADMIN_B_ORG_ID" \
    --admin-b-org-name "$ADMIN_B_ORG_NAME" \
    --admin-b-org-slug "$ADMIN_B_ORG_SLUG"

EXIT_CODE=$?

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… Test completed: No vulnerabilities detected"
else
    echo "âš ï¸  Test completed: VULNERABILITIES FOUND"
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“„ Check the generated JSON report for detailed results"
echo "ğŸ“– See TENANCY_VULNERABILITY_REPORT.md for remediation guidance"
echo ""

exit $EXIT_CODE




