# Tenancy Validation Vulnerability Report

**Date:** December 24, 2025  
**Severity:** HIGH  
**Status:** VULNERABLE  
**CVSS Score:** 8.1 (High)

---

## Executive Summary

A critical multi-tenancy security vulnerability exists in the `requireOrgScopedAdmin` middleware that allows organization-scoped administrators to access and modify data belonging to other organizations. This breaks the fundamental security boundary between tenants in the multi-tenant application.

**Impact:** Organization-scoped admins can:
- Read sensitive data from other organizations (PII disclosure)
- Modify settings and configurations of other organizations
- Create/manipulate hierarchy relationships in other organizations
- Access user lists and details across organizational boundaries

---

## Vulnerability Details

### Root Cause

The `requireOrgScopedAdmin()` middleware in [`backend/src/shared/middleware/rbac.middleware.ts`](backend/src/shared/middleware/rbac.middleware.ts) only validates the `organizationId` parameter when it appears in the **query string** (`req.query.organizationId`).

```typescript
// Lines 88-89 and 103-104
const requestedOrgId = req.query.organizationId as string | undefined;
if (requestedOrgId && requestedOrgId !== adminOrgId) {
  return res.status(403).json({ error: 'Organization access denied' });
}
```

However, many endpoints use the organization identifier from:
- **Request body** (`req.body.organizationId`)
- **Path parameters** (`req.params.id`, `req.params.organizationId`)
- **File content** (CSV uploads with embedded organization data)

When the organization ID is not in the query string, the middleware:
1. Sets `req.effectiveOrganizationId` to the admin's assigned organization
2. **Proceeds without validation** 
3. Allows the endpoint to use **any** organization ID from body/params/content

### Attack Flow

```
1. Admin A logs in ‚Üí Middleware assigns effectiveOrganizationId = "org-a-uuid"
2. Admin A sends: POST /hierarchy/bulk/csv with CSV containing "org-b" data
3. Middleware checks req.query.organizationId ‚Üí undefined (not present)
4. Middleware passes request (sets effectiveOrganizationId but doesn't validate)
5. Endpoint extracts organizationId from CSV ‚Üí "org-b-uuid"
6. Endpoint processes data for Org B WITHOUT checking effectiveOrganizationId
7. Result: Admin A successfully modifies Org B's data
```

---

## Affected Endpoints

### Critical (Direct Data Manipulation)

| Endpoint | Method | Parameter Location | Impact |
|----------|--------|-------------------|--------|
| `/api/v1/hierarchy/bulk/csv` | POST | CSV content | Create hierarchy in any org |
| `/api/v1/hierarchy` | POST | `req.body.organizationId` | Create hierarchy in any org |
| `/api/v1/hierarchy/bulk` | POST | `req.body.organizationId` | Bulk hierarchy update in any org |

### High (Configuration & Data Access)

| Endpoint | Method | Parameter Location | Impact |
|----------|--------|-------------------|--------|
| `/api/v1/admin/organizations/:id` | GET | `req.params.id` | Read org details |
| `/api/v1/admin/organizations/:id` | PUT | `req.params.id` | Modify org settings |
| `/api/v1/admin/organizations/slug/:slug` | GET | `req.params.slug` | Read org by slug |

### Medium (Information Disclosure)

| Endpoint | Method | Parameter Location | Impact |
|----------|--------|-------------------|--------|
| `/api/v1/admin/users/:id` | GET | `req.params.id` | Read user PII |
| `/api/v1/admin/users?organizationId=X` | GET | `req.query.organizationId` | May leak users (needs testing) |

---

## Proof of Concept

### Test Script

A comprehensive penetration test script is provided: [`test-tenancy-vulnerability.js`](test-tenancy-vulnerability.js)

### Prerequisites

You need:
1. **Admin A Token** - JWT token for an admin user in Organization A
2. **Org B Details** - ID, name, and slug of a different organization (Organization B)

Admin A should NOT have legitimate access to Organization B.

### Getting Test Parameters

#### 1. Get Admin A Token

```bash
# Login to staging
open https://feedbackflow-frontend-staging.onrender.com

# After login, open browser DevTools (F12)
# Go to: Application > Cookies > feedbackflow-frontend-staging.onrender.com
# Copy the "token" cookie value
```

#### 2. Get Organization B Details

```bash
# Login to staging as Admin A
# Go to: Administration > Organizations
# Find a DIFFERENT organization (not your own)
# Note down:
#   - Organization ID (UUID)
#   - Organization Name (e.g., "Acme Corp")
#   - Organization Slug (e.g., "acme-corp")
```

### Running the Test

**Method 1: Command-line arguments**

```bash
node test-tenancy-vulnerability.js \
  --admin-a-token "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  --admin-b-org-id "550e8400-e29b-41d4-a716-446655440000" \
  --admin-b-org-name "Acme Corp" \
  --admin-b-org-slug "acme-corp"
```

**Method 2: Environment variables**

```bash
export ADMIN_A_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
export ADMIN_B_ORG_ID="550e8400-e29b-41d4-a716-446655440000"
export ADMIN_B_ORG_NAME="Acme Corp"
export ADMIN_B_ORG_SLUG="acme-corp"

node test-tenancy-vulnerability.js
```

### Expected Output (Vulnerable System)

```
================================================================================
TENANCY VALIDATION VULNERABILITY TEST
================================================================================
Target: https://feedbackflow-backend-staging.onrender.com
Time: 2025-12-24T10:30:00.000Z

üîç Checking backend health...
‚úÖ Backend is healthy (PostgreSQL)

üîç Validating Admin A Token...
‚úÖ Admin A Token valid (has access to 1 org(s))

‚úÖ Prerequisites validated - starting attack tests...

--------------------------------------------------------------------------------
[1/5] Hierarchy CSV Upload Cross-Organization Attack
--------------------------------------------------------------------------------

üìã Description:
  Admin A attempts to upload hierarchy CSV containing Org B's data.
  CSV specifies organization by name/slug in each row.
  Middleware checks req.query.organizationId (not present).
  Endpoint uses organizationId from CSV without validation.

üì§ Sending malicious CSV:
  Organization: Acme Corp (acme-corp)
  Token: Admin A (authorized for Org A only)

üì• Response: 200 OK
Data: {
  "success": true,
  "data": {
    "created": 1,
    "updated": 0,
    "errors": []
  }
}

‚ö†Ô∏è  VULNERABILITY CONFIRMED ‚ö†Ô∏è
  Admin A can create hierarchy relationships in Org B!
  The organizationId from CSV is not validated against effectiveOrganizationId.

[... more tests ...]

================================================================================
TEST SUMMARY
================================================================================

Total Tests: 5
Vulnerable: 5
Protected: 0

‚ö†Ô∏è  CRITICAL SECURITY VULNERABILITIES CONFIRMED ‚ö†Ô∏è

Vulnerable Endpoints:
  ‚ùå [CRITICAL] Hierarchy CSV Upload Cross-Organization Attack
     POST /api/v1/hierarchy/bulk/csv
     Admin A uploads hierarchy for Org B via CSV
  ‚ùå [HIGH] Organization Details Access (Path Parameter)
     GET /api/v1/admin/organizations/:id
     Admin A reads Org B details via path parameter
  ‚ùå [HIGH] Organization Update (Path Parameter)
     PUT /api/v1/admin/organizations/:id
     Admin A updates Org B settings via path parameter
  ‚ùå [MEDIUM] User Data Access (Cross-Organization)
     GET /api/v1/admin/users?organizationId=:id
     Admin A requests Org B users via query parameter
  ‚ùå [CRITICAL] Hierarchy Creation (Body Parameter)
     POST /api/v1/hierarchy
     Admin A creates hierarchy in Org B via body parameter
```

---

## Business Impact

### Data Confidentiality Breach
- **PII Exposure**: Admin from Company A can read employee names, emails, positions from Company B
- **Organizational Structure**: Can view reporting hierarchies and org charts
- **Configuration Data**: Can see subscription plans, settings, departments

### Data Integrity Violation
- **Sabotage**: Can modify organization settings, causing operational disruption
- **Hierarchy Manipulation**: Can create false reporting relationships
- **Unauthorized Changes**: Can alter configurations without authorization

### Compliance Violations
- **GDPR Article 32**: Failure to ensure appropriate security of personal data
- **SOC 2**: Logical access controls not properly implemented
- **ISO 27001**: Access control policy violation

### Reputational Risk
- Loss of customer trust if exploited
- Potential data breach notification requirements
- Liability for damages caused by cross-tenant access

---

## Technical Analysis

### Why This Happens

The middleware design assumes:
1. **All organization identifiers will be in `req.query`**
2. **Endpoints will respect `req.effectiveOrganizationId`**

But in reality:
1. ‚ùå Many endpoints use path params (`/organizations/:id`)
2. ‚ùå Some use body params (`req.body.organizationId`)
3. ‚ùå CSV uploads embed organization in content
4. ‚ùå Controllers don't validate against `effectiveOrganizationId`

### Architecture Flaw

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ requireOrgScopedAdmin Middleware                                 ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ ‚úÖ Validates: req.query.organizationId                           ‚îÇ
‚îÇ ‚ùå Ignores:  req.params.id, req.body.organizationId, CSV content ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ Sets: req.effectiveOrganizationId = adminOrgId                   ‚îÇ
‚îÇ But doesn't enforce it!                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Controller (No Validation)                                       ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ const orgId = req.params.id;  // ‚ùå Not validated               ‚îÇ
‚îÇ await service.getOrganization(orgId);  // Processes any org!    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Recommended Fixes

### Fix 1: Middleware Enhancement (Recommended)

Add a validation helper function to the middleware:

```typescript
// backend/src/shared/middleware/rbac.middleware.ts

export function requireOrgScopedAdmin() {
  return (req: OrgScopedRequest, res: Response, next: NextFunction) => {
    // ... existing authentication and role checks ...
    
    // Add validation helper
    req.validateOrgAccess = (targetOrgId: string) => {
      if (req.isSuperAdmin) {
        return true; // Super admin can access any org
      }
      
      if (!req.effectiveOrganizationId) {
        throw new Error('Organization context not set');
      }
      
      if (targetOrgId !== req.effectiveOrganizationId) {
        throw new ForbiddenError(
          'You do not have permission to access this organization'
        );
      }
      
      return true;
    };
    
    next();
  };
}
```

**Then update all controllers:**

```typescript
// Example: Organization controller
getOrganizationById = async (req: Request, res: Response) => {
  const orgScopedReq = req as OrgScopedRequest;
  const targetOrgId = req.params.id;
  
  // VALIDATE ORGANIZATION ACCESS
  orgScopedReq.validateOrgAccess(targetOrgId);
  
  const organization = await this.service.getOrganizationById(targetOrgId);
  res.json(organization);
};

// Example: Hierarchy CSV upload
app.post('/api/v1/hierarchy/bulk/csv', 
  authenticateToken, 
  requireOrgScopedAdmin(), 
  async (req, res) => {
    const orgScopedReq = req as OrgScopedRequest;
    
    // Parse CSV
    for (const row of csvRows) {
      const orgId = await getOrgIdByNameAndSlug(row.orgName, row.orgSlug);
      
      // VALIDATE EACH ORGANIZATION
      orgScopedReq.validateOrgAccess(orgId);
      
      // Proceed with insertion...
    }
  }
);
```

### Fix 2: Separate Middleware for Path Parameters

Create a new middleware that validates path parameters:

```typescript
export function requireOrgAccess() {
  return (req: OrgScopedRequest, res: Response, next: NextFunction) => {
    const targetOrgId = req.params.orgId || 
                       req.params.organizationId || 
                       req.params.id;
    
    if (!targetOrgId) {
      return res.status(400).json({ error: 'Organization ID required' });
    }
    
    if (req.isSuperAdmin) {
      return next(); // Super admin can access any org
    }
    
    if (targetOrgId !== req.effectiveOrganizationId) {
      return res.status(403).json({ 
        error: 'Organization access denied',
        message: 'You do not have permission to access this organization'
      });
    }
    
    next();
  };
}
```

**Usage:**

```typescript
router.get('/organizations/:id', 
  requireOrgScopedAdmin(),  // Step 1: Check admin role
  requireOrgAccess(),       // Step 2: Validate path param
  controller.getOrganizationById
);
```

### Fix 3: Service Layer Validation

Add organization validation to all service methods:

```typescript
class AdminOrganizationService {
  async getOrganizationById(
    organizationId: string,
    effectiveOrgId?: string | null,
    isSuperAdmin?: boolean
  ): Promise<Organization> {
    // Validate access
    if (!isSuperAdmin && effectiveOrgId && organizationId !== effectiveOrgId) {
      throw new ForbiddenError('Access denied to this organization');
    }
    
    return this.model.getOrganizationById(organizationId);
  }
}
```

---

## Remediation Priority

### Immediate (Day 1)
1. ‚úÖ Document vulnerability and create test script
2. ‚è≥ Test on staging environment to confirm
3. ‚è≥ Notify security team and stakeholders

### Critical (Week 1)
1. ‚è≥ Implement Fix 1 or Fix 2 for all affected endpoints
2. ‚è≥ Add integration tests to verify fixes
3. ‚è≥ Deploy to staging and re-run vulnerability tests
4. ‚è≥ Deploy to production after verification

### Important (Week 2)
1. ‚è≥ Add automated security tests to CI/CD pipeline
2. ‚è≥ Conduct full security audit of all admin endpoints
3. ‚è≥ Review and update RBAC documentation

### Nice to Have (Month 1)
1. ‚è≥ Implement centralized authorization service
2. ‚è≥ Add audit logging for cross-org access attempts
3. ‚è≥ Security training for development team

---

## Testing After Fix

After implementing the fix, re-run the test script:

```bash
node test-tenancy-vulnerability.js \
  --admin-a-token "..." \
  --admin-b-org-id "..." \
  --admin-b-org-name "..." \
  --admin-b-org-slug "..."
```

**Expected output (fixed system):**

```
Total Tests: 5
Vulnerable: 0
Protected: 5

‚úÖ No vulnerabilities detected - System appears to be protected
```

All tests should return `403 Forbidden` or properly filtered results.

---

## Related Security Issues

This vulnerability is part of a broader issue:
- See: [`SECURITY_AUDIT_REPORT.md`](SECURITY_AUDIT_REPORT.md)
- Related: Privilege escalation via role assignment
- Related: Prompt injection in AI feedback generation

---

## References

- **OWASP Top 10 2021**: A01:2021 ‚Äì Broken Access Control
- **CWE-639**: Authorization Bypass Through User-Controlled Key
- **CWE-284**: Improper Access Control
- **NIST SP 800-53**: AC-3 (Access Enforcement)

---

## Contact

**Security Team**: security@feedbackflow.com  
**Report Created By**: Security Audit Team  
**Date**: December 24, 2025  
**Status**: UNDER INVESTIGATION

---

## Appendix: File Locations

### Vulnerable Code
- Middleware: [`backend/src/shared/middleware/rbac.middleware.ts`](backend/src/shared/middleware/rbac.middleware.ts) (lines 58-118)
- Hierarchy endpoints: [`backend/src/real-database-server.ts`](backend/src/real-database-server.ts) (lines 5121, 5272, 5310)
- Organization controller: [`backend/src/modules/admin/controllers/admin-organization.controller.ts`](backend/src/modules/admin/controllers/admin-organization.controller.ts)

### Test Scripts
- **Vulnerability test**: [`test-tenancy-vulnerability.js`](test-tenancy-vulnerability.js)
- **Prompt injection test**: [`test-prompt-injection.js`](test-prompt-injection.js)

### Documentation
- **Architecture**: [`ARCHITECTURE.md`](ARCHITECTURE.md)
- **Security guide**: [`SECURITY_TESTING_GUIDE.md`](SECURITY_TESTING_GUIDE.md)
- **Agent rules**: [`AGENTS.md`](AGENTS.md)

