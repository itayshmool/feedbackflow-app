# BAC & IDOR Vulnerability Test Results

**Date**: 2025-12-24  
**Tester**: Automated Security Testing Suite  
**Target**: FeedbackFlow Application - Localhost  
**Status**: ‚úÖ **VULNERABILITIES CONFIRMED**

---

## Executive Summary

Automated penetration testing has **successfully reproduced** three (3) critical Broken Access Control (BAC) and Insecure Direct Object Reference (IDOR) vulnerabilities in the FeedbackFlow application. These vulnerabilities allow authenticated users to:

1. **View cycles from any organization** (not just their own)
2. **Modify cycles from any organization** 
3. **Access participant data from any organization**

All tests were executed against a live backend instance running on `localhost:5000` with a real PostgreSQL database.

---

## Test Environment

- **Backend URL**: http://localhost:5000
- **Database**: PostgreSQL (Real) - postgres://itays@localhost:5432/feedbackflow
- **Backend Version**: 1.0.0
- **Test Framework**: Custom Node.js penetration testing script
- **Test Date**: December 24, 2025

---

## Vulnerability Test Results

### ‚úÖ TEST 1: CVE-001 - Cross-Organization Cycle Viewing

**Severity**: üî¥ **CRITICAL**

**Description**: Users from Organization A can view cycles belonging to Organization B

**Endpoint**: `GET /api/v1/cycles/:id`

**Test Scenario**:
- Created two separate organizations (Org A and Org B)
- Created a feedback cycle in Organization B
- Attempted to access the cycle using an authentication token from Organization A user

**Expected Behavior**: 
- HTTP 403 Forbidden
- Error message: "Access denied to resource from different organization"

**Actual Behavior**:
- ‚úÖ HTTP **200 OK**
- Successfully retrieved full cycle data including:
  - Cycle ID: `bcb00b38-ab4b-4c21-8b72-c93b6c0f10e6`
  - Organization ID from the response
  - Cycle name, dates, status, and all metadata

**Impact**: 
- Information disclosure vulnerability
- Users can enumerate and view all feedback cycles across all organizations
- Potential privacy violation (GDPR Article 32)

---

### ‚úÖ TEST 2: CVE-002 - Cross-Organization Cycle Modification

**Severity**: üî¥ **CRITICAL**

**Description**: Users from Organization A can modify cycles belonging to Organization B

**Endpoint**: `PUT /api/v1/cycles/:id`

**Test Scenario**:
- Used Organization A user token to modify Organization B cycle
- Sent malicious payload: `{ "name": "üö® HACKED BY ORG A üö®", "description": "Unauthorized modification" }`

**Expected Behavior**: 
- HTTP 403 Forbidden
- Modification should be blocked

**Actual Behavior**:
- ‚úÖ HTTP **200 OK**
- Cycle modification succeeded
- No organization validation performed

**Impact**: 
- Data integrity violation
- Malicious users can sabotage feedback cycles in competitor organizations
- Users can close active cycles, disrupting business operations
- Potential compliance violations (SOC 2 CC6.1)

---

### ‚úÖ TEST 3: CVE-005 - Cross-Organization Participant Access

**Severity**: üî¥ **CRITICAL**

**Description**: Users can view participant lists from cycles in any organization

**Endpoint**: `GET /api/v1/cycles/:id/participants`

**Test Scenario**:
- Created participant records in Organization B cycle
- Attempted to access participants using Organization A user token

**Expected Behavior**: 
- HTTP 403 Forbidden
- Participant data should not be accessible

**Actual Behavior**:
- ‚úÖ HTTP **200 OK**
- Successfully accessed participant endpoint
- Participant enumeration possible (0 participants in this test run, but endpoint accessible)

**Impact**: 
- User enumeration across organizations
- Exposure of employee IDs, roles, and participation status
- Privacy violation - users can discover who is being reviewed in other organizations

---

## Root Cause Analysis

### 1. **Missing Organization-Level Authorization**

**Location**: 
- `backend/src/modules/cycles/services/cycle.service.ts:122-135`
- `backend/src/modules/cycles/models/cycle.model.ts:43-64`

**Issue**: 
```typescript
// Service method receives userId but doesn't validate organization
async getCycleById(id: string, requestingUserId?: string): Promise<Cycle> {
  const cycle = await this.cycleModel.findById(id);  // ‚ùå No org filter
  
  if (!cycle) {
    throw new NotFoundError('Cycle not found');
  }
  
  // Permission check always returns true
  if (requestingUserId && !this.hasViewPermission(cycle, requestingUserId)) {
    throw new ForbiddenError('Insufficient permission to view this cycle');
  }
  
  return this.buildCompleteCycle(cycle);
}

// Permission check is a no-op
private hasViewPermission(cycle: CycleModel, userId: string): boolean {
  return true;  // ‚ùå Always allows access
}
```

**Database Query** (no organization filter):
```sql
SELECT fc.*
FROM feedback_cycles fc  
WHERE fc.id = $1  -- ‚ùå Missing: AND fc.organization_id = $2
```

### 2. **Broken RBAC - Roles Not Passed to Service Layer**

**Location**: `backend/src/modules/cycles/controllers/cycle.controller.ts:46-54`

**Issue**:
```typescript
updateCycle = async (req: Request, res: Response, next: NextFunction) => {
  const userId = (req as any).user?.id;
  // ‚ùå Doesn't pass: req.user.roles, req.user.organizationId
  const cycle = await this.cycleService.updateCycle(req.params.id, req.body, userId);
  res.json(cycle);
}
```

Service expects roles but never receives them:
```typescript
private hasUpdatePermission(cycle: CycleModel, userId: string, userRoles?: string[]): boolean {
  if (cycle.created_by === userId) {
    return true;  // Creator check works
  }
  
  // This code path never executes because userRoles is undefined
  if (userRoles) {  // ‚ùå Always undefined
    const roles = userRoles.map(r => r.toLowerCase());
    if (roles.includes('admin') || roles.includes('hr')) {
      return true;
    }
  }
  
  return false;
}
```

### 3. **Inconsistent Authorization Patterns**

- Notification deletion **does** validate ownership (secure)
- Cycle operations **don't** validate organization (vulnerable)
- No centralized authorization middleware
- No organization-scoped resource validation

---

## Attack Scenarios Demonstrated

### Scenario 1: Cycle Enumeration
```bash
# Attacker can iterate through cycle IDs to discover cycles across all orgs
for id in $(uuidgen | head -100); do
  curl -H "Authorization: Bearer <org-a-token>" \
    "http://localhost:5000/api/v1/cycles/$id"
done
```

### Scenario 2: Competitor Sabotage
```bash
# Attacker closes all active feedback cycles in competitor organization
curl -X POST -H "Authorization: Bearer <org-a-token>" \
  "http://localhost:5000/api/v1/cycles/<competitor-cycle-id>/close"
```

### Scenario 3: Employee Data Harvesting
```bash
# Attacker collects all participant data (employee IDs, roles)
curl -H "Authorization: Bearer <org-a-token>" \
  "http://localhost:5000/api/v1/cycles/<any-cycle-id>/participants"
```

---

## Test Execution Details

### Test Data Created
```
Organization A:
  ID: 15fa6f09-8abf-4e7c-b128-50e2031f3ebc
  User: user-a-1735069278539@test.com
  Token: Generated with employee role

Organization B:
  ID: 35a1c770-85da-40d6-913c-ae73e2503881
  User: user-b-1735069278539@test.com
  Cycle: bcb00b38-ab4b-4c21-8b72-c93b6c0f10e6
```

### HTTP Requests Made
```http
GET /api/v1/cycles/bcb00b38-ab4b-4c21-8b72-c93b6c0f10e6
Authorization: Bearer <org-a-token>
Result: 200 OK ‚úÖ VULNERABLE

PUT /api/v1/cycles/bcb00b38-ab4b-4c21-8b72-c93b6c0f10e6
Authorization: Bearer <org-a-token>
Content-Type: application/json
Body: {"name":"üö® HACKED BY ORG A üö®","description":"Unauthorized modification"}
Result: 200 OK ‚úÖ VULNERABLE

GET /api/v1/cycles/bcb00b38-ab4b-4c21-8b72-c93b6c0f10e6/participants
Authorization: Bearer <org-a-token>
Result: 200 OK ‚úÖ VULNERABLE
```

---

## Compliance Impact

| Standard | Control | Impact |
|----------|---------|--------|
| **GDPR** | Article 32 - Security of Processing | ‚ö†Ô∏è **Violation** - Unauthorized access to personal data |
| **SOC 2** | CC6.1 - Logical Access Controls | ‚ö†Ô∏è **Violation** - Insufficient access controls |
| **ISO 27001** | A.9 - Access Control | ‚ö†Ô∏è **Violation** - Missing organization-level authorization |
| **OWASP Top 10** | A01:2021 - Broken Access Control | ‚úÖ **Confirmed** - BAC vulnerability present |

---

## Affected Endpoints Summary

| Endpoint | Method | Status | Severity | Tested |
|----------|--------|--------|----------|--------|
| `/api/v1/cycles/:id` | GET | üî¥ VULNERABLE | CRITICAL | ‚úÖ |
| `/api/v1/cycles/:id` | PUT | üî¥ VULNERABLE | CRITICAL | ‚úÖ |
| `/api/v1/cycles/:id` | DELETE | üî¥ LIKELY VULNERABLE | CRITICAL | ‚è≠Ô∏è |
| `/api/v1/cycles/:id/activate` | POST | üî¥ LIKELY VULNERABLE | CRITICAL | ‚è≠Ô∏è |
| `/api/v1/cycles/:id/close` | POST | üî¥ LIKELY VULNERABLE | CRITICAL | ‚è≠Ô∏è |
| `/api/v1/cycles/:id/participants` | GET | üî¥ VULNERABLE | CRITICAL | ‚úÖ |
| `/api/v1/cycles/:id/participants` | POST | üî¥ LIKELY VULNERABLE | CRITICAL | ‚è≠Ô∏è |
| `/api/v1/cycles/:id/participants/:pid` | DELETE | üî¥ LIKELY VULNERABLE | CRITICAL | ‚è≠Ô∏è |
| `/api/v1/notifications/:id` | DELETE | ‚úÖ SECURE | N/A | ‚è≠Ô∏è (table not found) |

**Legend**: ‚úÖ Tested & Confirmed | ‚è≠Ô∏è Not Tested | üî¥ Vulnerable | ‚úÖ Secure

---

## Recommendations

### Immediate Actions (P0 - Within 24 hours)

1. **Add Organization Validation Middleware**
   ```typescript
   // Apply to all resource-specific routes
   router.get('/:id', validateResourceOrganization('cycle'), controller.getCycle);
   ```

2. **Update Database Queries**
   ```typescript
   async findById(id: string, organizationId: string): Promise<CycleModel | null> {
     const query = `
       SELECT * FROM feedback_cycles
       WHERE id = $1 AND organization_id = $2
     `;
     return await this.db.query(query, [id, organizationId]);
   }
   ```

3. **Fix Controller ‚Üí Service Role Passing**
   ```typescript
   updateCycle = async (req: Request, res: Response, next: NextFunction) => {
     const { id: userId, roles, organizationId } = (req as any).user;
     const cycle = await this.service.updateCycle(
       req.params.id, 
       req.body, 
       userId,
       roles,         // ‚úÖ Pass roles
       organizationId // ‚úÖ Pass org
     );
     res.json(cycle);
   };
   ```

### Short-term Actions (P1 - Within 1 week)

4. **Implement Centralized Authorization Library**
5. **Add Comprehensive Security Tests to CI/CD**
6. **Conduct Full Security Audit of All Modules**
7. **Add Security Logging for Cross-Org Access Attempts**

### Long-term Actions (P2 - Within 1 month)

8. **Implement Row-Level Security in PostgreSQL**
9. **Add API Rate Limiting Per Organization**
10. **Security Training for Development Team**

---

## Test Script Location

**Script**: `/Users/itays/dev/feedbackflow-app/scripts/test-bac-idor-localhost.js`

**Usage**:
```bash
cd /Users/itays/dev/feedbackflow-app
DATABASE_URL=postgres://itays@localhost:5432/feedbackflow \
JWT_SECRET="$(grep JWT_SECRET backend/.env | cut -d'=' -f2-)" \
node scripts/test-bac-idor-localhost.js
```

**Exit Code**: 
- `0` = All tests passed (no vulnerabilities)
- `1` = Vulnerabilities found (**current state**)

---

## Conclusion

The automated penetration testing suite has successfully **reproduced and confirmed** three critical BAC/IDOR vulnerabilities in the FeedbackFlow application. These vulnerabilities pose a **HIGH RISK** to data confidentiality, integrity, and compliance.

**Risk Level**: üî¥ **CRITICAL**  
**Exploitability**: ‚úÖ **TRIVIAL** (requires only valid authentication)  
**Business Impact**: ‚ö†Ô∏è **HIGH** (data breach, sabotage, compliance violations)

**Recommended Action**: **Immediate remediation required**. Deploy fixes to production within 24-48 hours and notify affected customers per incident response procedures.

---

**Test Report Generated**: 2025-12-24  
**Report Status**: FINAL  
**Classification**: CONFIDENTIAL - SECURITY SENSITIVE




